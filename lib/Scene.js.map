{"version":3,"sources":["../src/Scene.js"],"names":["Scene","id","opts","canvas","document","getElementById","$canvas","$","ctx","getContext","boxs","layers","reverseLayers","selected","visibleState","vissence","elementContainer","_initElementContainer","monitor","visible","_onFullyVisible","bind","hidden","_onHidden","start","elements","infinity","scaleX","scaleY","scale","initZoom","zoom","offsetX","offsetY","mousedown","originX","originY","doubleTap","tapDistance","originOffsetX","originOffsetY","_isMobile","on","_onTouchStart","_onTouchMove","_onTouchEnd","_onTouchCancel","_onContainerTouchStart","_onContainerTouchEnd","_onContainerTouchCancel","_onMouseUp","_onMouseDown","_onMouseMove","_onMouseOver","_onMouseOut","_onMouseWheel","_onContainerMouseUp","_onContainerMouseDown","_onContainerMouseOver","_onContainerMouseOut","test","navigator","userAgent","x0","y0","x1","y1","xdiff","ydiff","Math","pow","_resetElementContainer","_hiddenElementContainer","canvas_width","parseInt","css","canvas_height","border_top_width","border_right_width","border_bottom_width","border_left_width","display_state","isFullyVisible","container","addClass","display","overflow","width","height","position","left","offsetLeft","top","offsetTop","pointerEvents","append","box","layer","z","undefined","handle","i","unshift","element","attr","x","y","remove","realX","realY","zoomDelta","projX","projY","zoomX","zoomY","_zoomOffset","forEach","translateDeltaX","translateDeltaY","isElement","show_","render","paths","_getPaths","_include","e","preventDefault","pageX","pageY","_MouseUp","_onSelected","onMouseUp","_MouseDown","onMouseDown","onMouseMove","onTouch","onMouseOver","originalSelected","onMouseOut","_adjustTranslateOffset","from","fromElement","to","toElement","wheelDelta","_adjustZoomOffset","touches","length","_calcDistance","onTouchStart","tapCenterX","tapCenterY","diff","onTouchMove","onTouchEnter","onTouchLeave","changedTouches","onTouchEnd","target","show","hide","v1","mount","scene","setPosition","_addToDom","_addToLayer","_removeFromDom","_removeFromLayer","_removePosition","clear","_renderOne","clearRect","removeBox"],"mappings":"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","file":"Scene.js","sourcesContent":["import _ from 'lodash';\r\nimport uuid from 'node-uuid';\r\nimport VisSense from 'vissense';\r\n\r\nimport Context from './Context';\r\n\r\nexport default class Scene{\r\n    constructor(id, opts){\r\n        this.canvas = document.getElementById(id);\r\n        this.$canvas = $(this.canvas);\r\n        this.ctx = this.canvas.getContext('2d');\r\n        this.boxs = {};\r\n        this.layers = [];\r\n        this.reverseLayers = [];\r\n        this.selected = null;\r\n        this.visibleState = false;\r\n        this.vissence = VisSense(this.canvas);\r\n        this.elementContainer = this._initElementContainer();\r\n        this.vissence.monitor({\r\n            visible: this._onFullyVisible.bind(this),\r\n            hidden: this._onHidden.bind(this)\r\n        }).start();\r\n        this.elements = {};\r\n\r\n        // Options\r\n        this.opts = opts || {};\r\n        this.infinity = this.opts.infinity || false;\r\n        this.scaleX = this.opts.scaleX || 1;\r\n        this.scaleY = this.opts.scaleY || 1;\r\n        this.ctx.scale(this.scaleX, this.scaleY);\r\n        this.initZoom = this.zoom = this.opts.zoom || 1;\r\n\r\n        // Parameters associated with Infinite Canvas\r\n        this.offsetX = 0;\r\n        this.offsetY = 0;\r\n\r\n        // Parameters associated with Mousedown\r\n        this.mousedown = false;\r\n        this.originX = -1;\r\n        this.originY = -1;\r\n\r\n        // Parameters associated with zoom\r\n        this.doubleTap = false;\r\n        this.tapDistance = -1;\r\n\r\n        this.originOffsetX = 0;\r\n        this.originOffsetY = 0;\r\n\r\n        // Register Event\r\n        if(this._isMobile()){\r\n            this.$canvas.on('touchstart', this._onTouchStart.bind(this));\r\n            this.$canvas.on('touchmove', this._onTouchMove.bind(this));\r\n            this.$canvas.on('touchend', this._onTouchEnd.bind(this));\r\n            this.$canvas.on('touchcancel', this._onTouchCancel.bind(this));\r\n\r\n            this.elementContainer.on('touchstart', '*', this._onContainerTouchStart.bind(this));\r\n            this.elementContainer.on('touchmove', '*', this._onTouchMove.bind(this));\r\n            this.elementContainer.on('touchend', '*', this._onContainerTouchEnd.bind(this));\r\n            this.elementContainer.on('touchcancel', '*', this._onContainerTouchCancel.bind(this));\r\n        } else {\r\n            this.$canvas.on('mouseup', this._onMouseUp.bind(this));\r\n            this.$canvas.on('mousedown', this._onMouseDown.bind(this));\r\n            this.$canvas.on('mousemove', this._onMouseMove.bind(this));\r\n            this.$canvas.on('mouseover', this._onMouseOver.bind(this));\r\n            this.$canvas.on('mouseout', this._onMouseOut.bind(this));\r\n            this.$canvas.on('mousewheel', this._onMouseWheel.bind(this));\r\n\r\n            this.elementContainer.on('mouseup', '*', this._onContainerMouseUp.bind(this));\r\n            this.elementContainer.on('mousedown', '*', this._onContainerMouseDown.bind(this));\r\n            this.elementContainer.on('mousemove', '*', this._onMouseMove.bind(this));\r\n            this.elementContainer.on('mouseover', '*', this._onContainerMouseOver.bind(this));\r\n            this.elementContainer.on('mouseout', '*', this._onContainerMouseOut.bind(this));\r\n            this.elementContainer.on('mousewheel', '*', this._onMouseWheel.bind(this));\r\n        }\r\n    }\r\n\r\n    _isMobile(){\r\n        // return true;\r\n        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);\r\n    }\r\n\r\n    _calcDistance(x0, y0, x1, y1){\r\n        let xdiff = x1 - x0;\r\n        let ydiff = y1 - y0;\r\n        return Math.pow(xdiff * xdiff + ydiff * ydiff, 0.5);\r\n    }\r\n\r\n    _onFullyVisible(){\r\n        if(!this.visibleState){\r\n            this._resetElementContainer();\r\n        }\r\n    }\r\n\r\n    _onHidden(){\r\n        if(!!this.visibleState){\r\n            this._hiddenElementContainer();\r\n        }\r\n    }\r\n\r\n    _initElementContainer(){\r\n        let canvas_width = parseInt(this.$canvas.css('width'));\r\n        let canvas_height = parseInt(this.$canvas.css('height'));\r\n        let border_top_width = parseInt(this.$canvas.css('border-top-width'));\r\n        let border_right_width = parseInt(this.$canvas.css('border-right-width'));\r\n        let border_bottom_width = parseInt(this.$canvas.css('border-bottom-width'));\r\n        let border_left_width = parseInt(this.$canvas.css('border-left-width'));\r\n        let display_state = 'none';\r\n        if(this.vissence.isFullyVisible()){\r\n            display_state = 'inline-block';\r\n            this.visibleState = true;\r\n        }\r\n        let container = $('<div />');\r\n        container.addClass('boxElementContainer');\r\n        container.css({\r\n            display: display_state,\r\n            overflow: 'hidden',\r\n            width: canvas_width - border_left_width - border_right_width,\r\n            height: canvas_height - border_top_width - border_bottom_width,\r\n            position: 'absolute',\r\n            left: this.canvas.offsetLeft + border_left_width,\r\n            top: this.canvas.offsetTop + border_top_width,\r\n            pointerEvents: 'none'\r\n        });\r\n        $('body').append(container);\r\n        return container;\r\n    }\r\n\r\n    _resetElementContainer(){\r\n        let canvas_width = parseInt(this.$canvas.css('width')) +\r\n            parseInt(this.$canvas.css('border-left-width')) +\r\n            parseInt(this.$canvas.css('border-right-width'));\r\n        let canvas_height = parseInt(this.$canvas.css('height')) +\r\n            parseInt(this.$canvas.css('border-top-width')) +\r\n            parseInt(this.$canvas.css('border-bottom-width'));\r\n        let border_top_width = parseInt(this.$canvas.css('border-top-width'));\r\n        let border_right_width = parseInt(this.$canvas.css('border-right-width'));\r\n        let border_bottom_width = parseInt(this.$canvas.css('border-bottom-width'));\r\n        let border_left_width = parseInt(this.$canvas.css('border-left-width'));\r\n        this.elementContainer.css({\r\n            display: 'inline-block',\r\n            overflow: 'hidden',\r\n            width: canvas_width - border_left_width - border_right_width,\r\n            height: canvas_height - border_top_width - border_bottom_width,\r\n            position: 'absolute',\r\n            left: this.canvas.offsetLeft + border_left_width,\r\n            top: this.canvas.offsetTop + border_top_width,\r\n            pointerEvents: 'none'\r\n        });\r\n        this.visibleState = true;\r\n    }\r\n\r\n    _hiddenElementContainer(){\r\n        this.elementContainer.css({\r\n            display: 'none',\r\n        });\r\n        this.visibleState = false;\r\n    }\r\n\r\n    _addToLayer(box){\r\n        let layer = this.layers[box.z];\r\n        if(layer == undefined){\r\n            layer = {};\r\n            this.layers[box.z] = layer;\r\n        }\r\n        layer[box.handle] = box;\r\n        this.reverseLayers = [];\r\n        for(var i in this.layers){\r\n            this.reverseLayers.unshift(this.layers[i]);\r\n        }\r\n    }\r\n\r\n    _addToDom(box){\r\n        this.elements[box.handle] = box;\r\n        box.element.attr('handle', box.handle);\r\n        box.element.css('pointer-events', 'auto');\r\n        box.element.css('display', 'inline-block');\r\n        box.element.css('position', 'absolute');\r\n        box.element.css('left', box.x);\r\n        box.element.css('top', box.y);\r\n        this.elementContainer.append(box.element);\r\n    }\r\n\r\n    _removeFromLayer(box){\r\n        let layer = this.layers[box.z];\r\n        if(layer != undefined){\r\n            delete layer[box.handle];\r\n        }\r\n    }\r\n\r\n    _removeFromDom(box){\r\n        box.element.remove();\r\n        delete this.elements[box.handle];\r\n    }\r\n\r\n    _reversePos(realX, realY){\r\n        let x = (realX - this.originOffsetX) * this.initZoom / this.zoom;\r\n        let y = (realY - this.originOffsetY) * this.initZoom / this.zoom;\r\n        return [x, y];\r\n    }\r\n\r\n    _reverseOffset(x, y){\r\n        let realX = x * this.zoom / this.initZoom + this.originOffsetX;\r\n        let realY = y * this.zoom / this.initZoom + this.originOffsetY;\r\n        return [realX - x, realY - y];\r\n    }\r\n\r\n    _zoomOffset(originX, originY, x, y, zoomDelta){\r\n        let projX = x - originX;\r\n        let projY = y - originY;\r\n        projX *= zoomDelta;\r\n        projY *= zoomDelta;\r\n        let zoomX = projX + originX;\r\n        let zoomY = projY + originY;\r\n        return [zoomX - x, zoomY - y];\r\n    }\r\n\r\n    _adjustZoomOffset(originX, originY, zoomDelta){\r\n        let [offsetX, offsetY] = this._zoomOffset(originX, originY, this.originOffsetX, this.originOffsetY, zoomDelta);\r\n        this.originOffsetX += offsetX;\r\n        this.originOffsetY += offsetY;\r\n        _.forEach(this.boxs, function(box, handle){\r\n            let [offsetX, offsetY] = this._zoomOffset(originX, originY, box.x + box.offsetX, box.y + box.offsetY, zoomDelta);\r\n            box.offsetX += offsetX;\r\n            box.offsetY += offsetY;\r\n        }.bind(this));\r\n    }\r\n\r\n    _adjustTranslateOffset(translateDeltaX, translateDeltaY){\r\n        this.originOffsetX += translateDeltaX;\r\n        this.originOffsetY += translateDeltaY;\r\n        _.forEach(this.boxs, function(box, handle){\r\n            box.offsetX += translateDeltaX;\r\n            box.offsetY += translateDeltaY;\r\n        }.bind(this));\r\n    }\r\n\r\n    _renderOne(box){\r\n        let [x, y] = [box.x + box.offsetX, box.y + box.offsetY];\r\n        if(box.isElement){\r\n            if(box.show_){\r\n                box.element.css('display', 'inline-block');\r\n                box.element.css('left', x);\r\n                box.element.css('top', y);\r\n                box.element.css('z-index', box.z);\r\n                box.element.css('transform', `scale(${this.zoom}, ${this.zoom})`);\r\n                box.element.css('transform-origin', 'left top');\r\n            } else {\r\n                box.element.css('display', 'none');\r\n            }\r\n        } else if(box.show_) {\r\n            let ctx = new Context(this.ctx, x, y, this.zoom);\r\n            box.render(ctx);\r\n            box.paths = ctx._getPaths();\r\n        }\r\n    }\r\n\r\n    _onSelected(x, y){\r\n        x = x * this.scaleX;\r\n        y = y * this.scaleY;\r\n        let selected = null;\r\n        for(var i in this.reverseLayers){\r\n            let layer = this.reverseLayers[i];\r\n            for(var handle in layer){\r\n                let box = layer[handle];\r\n                if(box._include(x, y)){\r\n                    selected = box;\r\n                    break;\r\n                }\r\n            }\r\n            if(selected != undefined){\r\n                break;\r\n            }\r\n        }\r\n        return selected;\r\n    }\r\n\r\n    // Methods associated with Mousedown\r\n\r\n    _MouseDown(x, y){\r\n        this.mousedown = true;\r\n        this.originX = x;\r\n        this.originY = y;\r\n    }\r\n\r\n    _MouseUp(){\r\n        this.mousedown = false;\r\n        this.originX = -1;\r\n        this.originY = -1;\r\n    }\r\n\r\n    // Canvas Events\r\n\r\n    _onMouseUp(e){\r\n        e.preventDefault();\r\n        let x = e.pageX - this.canvas.offsetLeft;\r\n        let y = e.pageY - this.canvas.offsetTop;\r\n        this._MouseUp();\r\n        let selected = this._onSelected(x, y);\r\n        if(selected != undefined){\r\n            selected.onMouseUp(e, x, y);\r\n        }\r\n        this.onMouseUp(e, x, y, selected);\r\n    }\r\n\r\n    _onMouseDown(e){\r\n        e.preventDefault();\r\n        let x = e.pageX - this.canvas.offsetLeft;\r\n        let y = e.pageY - this.canvas.offsetTop;\r\n        this._MouseDown(x, y);\r\n        let selected = this._onSelected(x, y);\r\n        if(selected != undefined){\r\n            selected.onMouseDown(e, x, y);\r\n        }\r\n        this.onMouseDown(e, x, y, selected);\r\n    }\r\n\r\n    _onMouseMove(e){\r\n        e.preventDefault();\r\n        let x = e.pageX - this.canvas.offsetLeft;\r\n        let y = e.pageY - this.canvas.offsetTop;\r\n        this.onMouseMove(e, x, y);\r\n        let selected = this._onSelected(x, y);\r\n        if(selected != undefined){\r\n            if(this.selected == undefined || this.selected.handle != selected.handle){\r\n                this.selected = selected;\r\n                this.onTouch(e, x, y, selected);\r\n                selected.onMouseOver(e, x, y);\r\n            }\r\n        } else {\r\n            if(this.selected != undefined){\r\n                let originalSelected = this.selected;\r\n                this.selected = selected;\r\n                this.onTouch(e, x, y, selected);\r\n                originalSelected.onMouseOut(e, x, y);\r\n            }\r\n            if(this.infinity && this.mousedown){\r\n                let translateDeltaX = x - this.originX;\r\n                let translateDeltaY = y - this.originY;\r\n                this.offsetX += translateDeltaX;\r\n                this.offsetY += translateDeltaY;\r\n                this.originX = x;\r\n                this.originY = y;\r\n                this._adjustTranslateOffset(translateDeltaX, translateDeltaY);\r\n                this.render();\r\n            }\r\n        }\r\n    }\r\n\r\n    _onMouseOver(e){\r\n        e.preventDefault();\r\n        let from = $(e.fromElement);\r\n        if(from.attr('handle') in this.elements){\r\n            return;\r\n        }\r\n        let x = e.pageX - this.canvas.offsetLeft;\r\n        let y = e.pageY - this.canvas.offsetTop;\r\n        this.onMouseOver(e, x, y);\r\n    }\r\n\r\n    _onMouseOut(e){\r\n        e.preventDefault();\r\n        let to = $(e.toElement);\r\n        if(to.attr('handle') in this.elements){\r\n            return;\r\n        }\r\n        let x = e.pageX - this.canvas.offsetLeft;\r\n        let y = e.pageY - this.canvas.offsetTop;\r\n        this._MouseUp();\r\n        this.onMouseOut(e, x, y);\r\n    }\r\n\r\n    _onMouseWheel(e){\r\n        e.preventDefault();\r\n        let x = e.pageX - this.canvas.offsetLeft;\r\n        let y = e.pageY - this.canvas.offsetTop;\r\n        let zoomDelta = 1 + e.wheelDelta / 120 / 20;\r\n        this.zoom *= zoomDelta;\r\n        this._adjustZoomOffset(x, y, zoomDelta);\r\n        this.render();\r\n    }\r\n\r\n    // Canvas Touch Events\r\n\r\n    _onTouchStart(e){\r\n        e.preventDefault();\r\n        if(e.touches.length === 2){\r\n            this.doubleTap = true;\r\n            this.tapDistance = this._calcDistance(\r\n                e.touches[0].pageX, e.touches[0].pageY,\r\n                e.touches[1].pageX, e.touches[1].pageY\r\n                );\r\n        }\r\n        let x = e.touches[0].pageX - this.canvas.offsetLeft;\r\n        let y = e.touches[0].pageY - this.canvas.offsetTop;\r\n        this._MouseDown(x, y);\r\n        let selected = this._onSelected(x, y);\r\n        if(selected != undefined){\r\n            selected.onTouchStart(e, x, y);\r\n        }\r\n        this.onTouchStart(e, x, y, selected);\r\n    }\r\n\r\n    _onTouchMove(e){\r\n        e.preventDefault();\r\n        if(e.touches.length === 2 && this.doubleTap){\r\n            let tapDistance = this._calcDistance(\r\n                e.touches[0].pageX, e.touches[0].pageY,\r\n                e.touches[1].pageX, e.touches[1].pageY\r\n                );\r\n            let tapCenterX = (e.touches[0].pageX + e.touches[1].pageX) / 2;\r\n            let tapCenterY = (e.touches[0].pageY + e.touches[1].pageY) / 2;\r\n            let diff = this.tapDistance - tapDistance;\r\n            let zoomDelta = 1 - diff / this.canvas.width * 2;\r\n            this.zoom *= zoomDelta;\r\n            this._adjustZoomOffset(tapCenterX, tapCenterY, zoomDelta);\r\n            this.render();\r\n            this.tapDistance = tapDistance;\r\n        }\r\n        let x = e.touches[0].pageX - this.canvas.offsetLeft;\r\n        let y = e.touches[0].pageY - this.canvas.offsetTop;\r\n        this.onTouchMove(e, x, y);\r\n        let selected = this._onSelected(x, y);\r\n        if(selected != undefined){\r\n            if(this.selected == undefined || this.selected.handle != selected.handle){\r\n                this.selected = selected;\r\n                this.onTouch(e, x, y, selected);\r\n                selected.onTouchEnter(e, x, y);\r\n            }\r\n        } else {\r\n            if(this.selected != undefined){\r\n                let originalSelected = this.selected;\r\n                this.selected = selected;\r\n                this.onTouch(e, x, y, selected);\r\n                originalSelected.onTouchLeave(e, x, y);\r\n            }\r\n            if(this.infinity && this.mousedown && e.touches.length === 1){\r\n                let translateDeltaX = x - this.originX;\r\n                let translateDeltaY = y - this.originY;\r\n                this.offsetX += translateDeltaX;\r\n                this.offsetY += translateDeltaY;\r\n                this.originX = x;\r\n                this.originY = y;\r\n                this._adjustTranslateOffset(translateDeltaX, translateDeltaY);\r\n                this.render();\r\n            }\r\n        }\r\n    }\r\n\r\n    _onTouchEnd(e){\r\n        e.preventDefault();\r\n        if(e.touches.length !== 2){\r\n            this.doubleTap = false;\r\n            this.tapDistance = -1;\r\n        }\r\n        let x = e.changedTouches[0].pageX - this.canvas.offsetLeft;\r\n        let y = e.changedTouches[0].pageY - this.canvas.offsetTop;\r\n        this._MouseUp();\r\n        let selected = this._onSelected(x, y);\r\n        if(selected != undefined){\r\n            selected.onTouchEnd(e, x, y);\r\n        }\r\n        this.onTouchEnd(e, x, y, selected);\r\n    }\r\n\r\n    _onTouchCancel(e){\r\n        this._onTouchEnd(e);\r\n    }\r\n\r\n    // Elements Container Touch Events\r\n\r\n    _onContainerTouchStart(e){\r\n        e.preventDefault();\r\n        if(e.touches.length === 2){\r\n            this.doubleTap = true;\r\n            this.tapDistance = this._calcDistance(\r\n                e.touches[0].pageX, e.touches[0].pageY,\r\n                e.touches[1].pageX, e.touches[1].pageY\r\n                );\r\n        }\r\n        let element = $(e.target);\r\n        if(element.attr('handle') != undefined){\r\n            let box = this.elements[element.attr('handle')];\r\n            if(box != undefined){\r\n                let x = e.touches[0].pageX - this.canvas.offsetLeft;\r\n                let y = e.touches[0].pageY - this.canvas.offsetTop;\r\n                this.onTouchStart(e, x, y, box);\r\n                box.onTouchStart(e, x, y);\r\n            }\r\n        }\r\n    }\r\n\r\n    _onContainerTouchEnd(e){\r\n        e.preventDefault();\r\n        if(e.touches.length !== 2){\r\n            this.doubleTap = false;\r\n            this.tapDistance = -1;\r\n        }\r\n        let element = $(e.target);\r\n        if(element.attr('handle') != undefined){\r\n            let box = this.elements[element.attr('handle')];\r\n            if(box != undefined){\r\n                let x = e.changedTouches[0].pageX - this.canvas.offsetLeft;\r\n                let y = e.changedTouches[0].pageY - this.canvas.offsetTop;\r\n                this.onTouchEnd(e, x, y, box);\r\n                box.onTouchEnd(e, x, y);\r\n            }\r\n        }\r\n    }\r\n\r\n    _onContainerTouchCancel(e){\r\n        this._onContainerTouchEnd(e);\r\n    }\r\n\r\n    // Elements Container Events\r\n\r\n    _onContainerMouseUp(e){\r\n        // http://stackoverflow.com/questions/13236484/mouseup-not-working-after-mousemove-on-img\r\n        e.preventDefault();\r\n        let element = $(e.target);\r\n        if(element.attr('handle') != undefined){\r\n            let box = this.elements[element.attr('handle')];\r\n            if(box != undefined){\r\n                let x = e.pageX - this.canvas.offsetLeft;\r\n                let y = e.pageY - this.canvas.offsetTop;\r\n                this.onMouseUp(e, x, y, box);\r\n                box.onMouseUp(e, x, y);\r\n            }\r\n        }\r\n    }\r\n\r\n    _onContainerMouseDown(e){\r\n        e.preventDefault();\r\n        let element = $(e.target);\r\n        if(element.attr('handle') != undefined){\r\n            let box = this.elements[element.attr('handle')];\r\n            if(box != undefined){\r\n                let x = e.pageX - this.canvas.offsetLeft;\r\n                let y = e.pageY - this.canvas.offsetTop;\r\n                this.onMouseDown(e, x, y, box);\r\n                box.onMouseDown(e, x, y);\r\n            }\r\n        }\r\n    }\r\n\r\n    _onContainerMouseOver(e){\r\n        e.preventDefault();\r\n        let element = $(e.target);\r\n        if(element.attr('handle') != undefined){\r\n            let box = this.elements[element.attr('handle')];\r\n            if(box != undefined){\r\n                let x = e.pageX - this.canvas.offsetLeft;\r\n                let y = e.pageY - this.canvas.offsetTop;\r\n                this.onTouch(e, x, y, box);\r\n                box.onMouseOver(e, x, y);\r\n                if(x > 0 && x < this.canvas.width &&\r\n                    y > 0 && y < this.canvas.height){\r\n                        this.onMouseOver(e, x, y);\r\n                    }\r\n            }\r\n        }\r\n    }\r\n\r\n    _onContainerMouseOut(e){\r\n        e.preventDefault();\r\n        let element = $(e.target);\r\n        if(element.attr('handle') != undefined){\r\n            let box = this.elements[element.attr('handle')];\r\n            if(box != undefined){\r\n                let x = e.pageX - this.canvas.offsetLeft;\r\n                let y = e.pageY - this.canvas.offsetTop;\r\n                this.onTouch(e, x, y, null);\r\n                box.onMouseOut(e, x, y);\r\n                if(x < 0 || x > this.canvas.width ||\r\n                    y < 0 || y > this.canvas.height){\r\n                        this._MouseUp();\r\n                        this.onMouseOut(e, x, y);\r\n                    }\r\n            }\r\n        }\r\n    }\r\n\r\n    // Public Methods\r\n\r\n    show(){\r\n        if(!this.visibleState){\r\n            this.$canvas.show();\r\n            this._onFullyVisible();\r\n            this.visibleState = true;\r\n        }\r\n    }\r\n\r\n    hide(){\r\n        if(!!this.visibleState){\r\n            this.$canvas.hide();\r\n            this._onHidden();\r\n            this.visibleState = false;\r\n        }\r\n    }\r\n\r\n    addBox(box, x, y, z){\r\n        let handle = box.handle = uuid.v1();\r\n        this.boxs[handle] = box;\r\n        box.mount = true;\r\n        box.scene = this;\r\n        box.setPosition(x, y, z);\r\n        if(box.isElement){\r\n            this._addToDom(box);\r\n        } else {\r\n            this._addToLayer(box);\r\n        }\r\n        this.render();\r\n        return handle;\r\n    }\r\n\r\n    removeBox(handle){\r\n        let box = this.boxs[handle];\r\n        if(box != undefined){\r\n            if(box.isElement){\r\n                this._removeFromDom(box);\r\n            } else {\r\n                this._removeFromLayer(box);\r\n                this.render();\r\n            }\r\n            delete this.boxs[handle];\r\n            box._removePosition();\r\n            box.scene = null;\r\n            box.mount = false;\r\n            return true;\r\n        } else {\r\n            return false;\r\n        }\r\n    }\r\n\r\n    setZoom(zoom = 1, originX = 0, originY = 0){\r\n        let zoomDelta = zoom / this.zoom;\r\n        this.zoom = zoom;\r\n        this._adjustZoomOffset(originX, originY, zoomDelta);\r\n    }\r\n\r\n    render(){\r\n        this.clear();\r\n        for(var i in this.layers){\r\n            let layer = this.layers[i];\r\n            _.forEach(layer, function(box, handle){\r\n                this._renderOne(box);\r\n            }.bind(this));\r\n        }\r\n        _.forEach(this.elements, function(element){\r\n            this._renderOne(element);\r\n        }.bind(this));\r\n    }\r\n\r\n    clear(){\r\n        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n    }\r\n\r\n    close(){\r\n        _.forEach(this.boxs, function(box, handle){\r\n            this.removeBox(handle);\r\n        }.bind(this));\r\n        this.clear();\r\n    }\r\n\r\n    // events\r\n\r\n    onMouseUp(e, x, y, box){\r\n        // override it\r\n    }\r\n\r\n    onMouseDown(e, x, y, box){\r\n        // override it\r\n    }\r\n\r\n    onMouseMove(e, x, y){\r\n        // override it\r\n    }\r\n\r\n    onMouseOver(e, x, y){\r\n        // override it\r\n    }\r\n\r\n    onMouseOut(e, x, y){\r\n        // override it\r\n    }\r\n\r\n    onTouch(e, x, y, box){\r\n        // override it\r\n    }\r\n\r\n    // touch events\r\n\r\n    onTouchStart(e, x, y, box){\r\n        // override it\r\n    }\r\n\r\n    onTouchMove(e, x, y){\r\n        // override it\r\n    }\r\n\r\n    onTouchEnd(e, x, y, box){\r\n        // override it\r\n    }\r\n\r\n}"]}