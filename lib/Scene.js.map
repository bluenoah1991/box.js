{"version":3,"sources":["../src/Scene.js"],"names":["Scene","id","canvas","document","getElementById","ctx","getContext","layers","reverseLayers","selected","onmouseup","_onMouseUp","bind","onmousedown","_onMouseDown","onmousemove","_onMouseMove","onmouseover","_onMouseOver","onmouseout","_onMouseOut","box","layer","z","undefined","handle","i","unshift","x","y","render","paths","_getPaths","_include","e","pageX","offsetLeft","pageY","offsetTop","_onSelected","onMouseUp","onMouseDown","onMouseMove","onTouch","onMouseOver","onMouseOut","v1","setPosition","_addToLayer","scene","mount","clear","forEach","_renderOne","clearRect","width","height"],"mappings":"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","file":"Scene.js","sourcesContent":["import _ from 'lodash';\r\nimport uuid from 'node-uuid';\r\n\r\nimport Context from './Context';\r\n\r\nexport default class Scene{\r\n    constructor(id){\r\n        this.canvas = document.getElementById(id);\r\n        this.ctx = this.canvas.getContext('2d');\r\n        this.layers = [];\r\n        this.reverseLayers = [];\r\n        this.selected = null;\r\n\r\n        this.canvas.onmouseup = this._onMouseUp.bind(this);\r\n        this.canvas.onmousedown = this._onMouseDown.bind(this);\r\n        this.canvas.onmousemove = this._onMouseMove.bind(this);\r\n\r\n        this.canvas.onmouseover = this._onMouseOver.bind(this);\r\n        this.canvas.onmouseout = this._onMouseOut.bind(this);\r\n    }\r\n\r\n    _addToLayer(box){\r\n        let layer = this.layers[box.z];\r\n        if(layer == undefined){\r\n            layer = {};\r\n            this.layers[box.z] = layer;\r\n        }\r\n        layer[box.handle] = box;\r\n        this.reverseLayers = [];\r\n        for(var i in this.layers){\r\n            this.reverseLayers.unshift(this.layers[i]);\r\n        }\r\n    }\r\n\r\n    _renderOne(box){\r\n        let ctx = new Context(this.ctx, box.x, box.y);\r\n        box.render(ctx);\r\n        box.paths = ctx._getPaths();\r\n    }\r\n\r\n    _onSelected(x, y){\r\n        let selected = null;\r\n        for(var i in this.reverseLayers){\r\n            let layer = this.reverseLayers[i];\r\n            for(var handle in layer){\r\n                let box = layer[handle];\r\n                if(box._include(x, y)){\r\n                    selected = box;\r\n                    break;\r\n                }\r\n            }\r\n            if(selected != undefined){\r\n                break;\r\n            }\r\n        }\r\n        return selected;\r\n    }\r\n\r\n    _onMouseUp(e){\r\n        let x = e.pageX - this.canvas.offsetLeft;\r\n        let y = e.pageY - this.canvas.offsetTop;\r\n        let selected = this._onSelected(x, y);\r\n        this.onMouseUp(e, x, y, selected);\r\n    }\r\n\r\n    _onMouseDown(e){\r\n        let x = e.pageX - this.canvas.offsetLeft;\r\n        let y = e.pageY - this.canvas.offsetTop;\r\n        let selected = this._onSelected(x, y);\r\n        this.onMouseDown(e, x, y, selected);\r\n    }\r\n\r\n    _onMouseMove(e){\r\n        let x = e.pageX - this.canvas.offsetLeft;\r\n        let y = e.pageY - this.canvas.offsetTop;\r\n        this.onMouseMove(e, x, y);\r\n        let selected = this._onSelected(x, y);\r\n        if(selected != undefined){\r\n            if(this.selected == undefined || this.selected.handle != selected.handle){\r\n                this.selected = selected;\r\n                this.onTouch(e, x, y, selected);\r\n            }\r\n        } else {\r\n            if(this.selected != undefined){\r\n                this.selected = selected;\r\n                this.onTouch(e, x, y, selected);\r\n            }\r\n        }\r\n    }\r\n\r\n    _onMouseOver(e){\r\n        let x = e.pageX - this.canvas.offsetLeft;\r\n        let y = e.pageY - this.canvas.offsetTop;\r\n        this.onMouseOver(e, x, y);\r\n    }\r\n\r\n    _onMouseOut(e){\r\n        let x = e.pageX - this.canvas.offsetLeft;\r\n        let y = e.pageY - this.canvas.offsetTop;\r\n        this.onMouseOut(e, x, y);\r\n    }\r\n\r\n    addBox(box, x, y, z){\r\n        let handle = box.handle = uuid.v1();\r\n        box.setPosition(x, y);\r\n        box.z = z || 0;\r\n        this._addToLayer(box);\r\n        this.render();\r\n        box.scene = this;\r\n        box.mount = true;\r\n        return handle;\r\n    }\r\n\r\n    render(){\r\n        this.clear();\r\n        for(var i in this.layers){\r\n            let layer = this.layers[i];\r\n            _.forEach(layer, function(box, handle){\r\n                this._renderOne(box);\r\n            }.bind(this));\r\n        }\r\n    }\r\n\r\n    clear(){\r\n        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n    }\r\n\r\n    // events\r\n\r\n    onMouseUp(e, x, y, box){\r\n        // override it\r\n    }\r\n\r\n    onMouseDown(e, x, y, box){\r\n        // override it\r\n    }\r\n\r\n    onMouseMove(e, x, y){\r\n        // override it\r\n    }\r\n\r\n    onMouseOver(e, x, y){\r\n        // override it\r\n    }\r\n\r\n    onMouseOut(e, x, y){\r\n        // override it\r\n    }\r\n\r\n    onTouch(e, x, y, box){\r\n        // override it\r\n    }\r\n\r\n}"]}